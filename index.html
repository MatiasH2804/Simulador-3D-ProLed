<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador 3D LED Pro – v6.2 (Final Stable)</title>
  <style>
    /* --- CSS GLOBAL (UI Clean) --- */
    :root {
      --panel-bg: rgba(10, 12, 16, 0.90);
      --panel-border: rgba(255, 255, 255, 0.1);
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --btn-bg: rgba(255, 255, 255, 0.05);
      --btn-hover: rgba(255, 255, 255, 0.12);
      --input-bg: rgba(0, 0, 0, 0.4);
      --input-border: rgba(255, 255, 255, 0.1);
      --input-focus: rgba(59, 130, 246, 0.5);
      --card-bg: rgba(255, 255, 255, 0.03);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      --modal-overlay: rgba(0, 0, 0, 0.85);
      --transition: 0.15s ease;
    }

    html, body { height:100%; margin:0; overflow:hidden; font-family: 'Inter', system-ui, sans-serif; background: #000; letter-spacing: -0.01em; color: var(--text); }
    #gl { display:block; width:100vw; height:100vh; position:relative; z-index:5; outline: none; }

    /* PANEL LATERAL */
    #panel {
      position:fixed; top:12px; left:12px; z-index:10;
      width:340px; max-height:calc(100vh - 24px); overflow-y:auto;
      padding:16px; background: var(--panel-bg); border: 1px solid var(--panel-border);
      border-radius: 12px; backdrop-filter: blur(12px); box-shadow: var(--shadow);
      font-size: 13px;
    }
    #panel::-webkit-scrollbar { width:4px; }
    #panel::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.2); border-radius:2px; }

    #topBar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom: 8px; border-bottom: 1px solid var(--panel-border); }
    #projName { font-size:14px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px; }
    
    .iconBtn { background:transparent; border:none; color:var(--text); cursor:pointer; padding:6px; border-radius:4px; opacity:0.7; transition: var(--transition); }
    .iconBtn:hover { opacity:1; background:var(--btn-hover); }
    .iconBtn svg { width:16px; height:16px; fill:currentColor; }

    .row { display:flex; align-items:center; gap:8px; margin:8px 0; min-height: 28px; }
    label { flex:0 0 85px; font-size:11px; font-weight: 600; color:var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    
    input[type="text"], input[type="number"], select {
      background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text);
      border-radius: 4px; padding: 4px 6px; font-size: 12px; width: 100%; outline: none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--accent); }
    input[type="number"] { width:60px; text-align: right; }
    select { cursor: pointer; }

    /* --- SLIDER CSS FIXED (Cross-Browser) --- */
    input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 100%; background: transparent; height: 16px; cursor: pointer; outline: none; flex: 1;
    }
    /* Webkit (Chrome/Safari) */
    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 12px; width: 12px; 
      background: var(--text); border-radius: 50%; margin-top: -4px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.5); transition: transform 0.1s;
    }
    input[type="range"]:hover::-webkit-slider-thumb { transform: scale(1.2); background: var(--accent); }
    /* Firefox */
    input[type="range"]::-moz-range-track {
      width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;
    }
    input[type="range"]::-moz-range-thumb {
      height: 12px; width: 12px; background: var(--text); border: none; border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.5); transition: transform 0.1s;
    }
    input[type="range"]:hover::-moz-range-thumb { transform: scale(1.2); background: var(--accent); }

    input[type="color"] { width:100%; height:24px; border:1px solid var(--input-border); background:var(--input-bg); padding:1px; cursor:pointer; }
    input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer; }

    button.action {
      flex:1; padding:6px 10px; border-radius:4px; font-size:11px; font-weight:600;
      border:1px solid var(--panel-border); background:var(--btn-bg); color:var(--text); cursor:pointer; transition: var(--transition);
    }
    button.action:hover { background:var(--btn-hover); border-color:rgba(255,255,255,0.2); }
    button.primary { background:var(--accent); color:#fff; border-color: transparent; }
    button.primary:hover { background:var(--accent-hover); }
    button.danger { background:rgba(220, 38, 38, 0.15); color:#fca5a5; border-color:rgba(220, 38, 38, 0.3); }

    .hr { height:1px; background:var(--panel-border); margin:12px 0; opacity: 0.5; }
    .card { border-radius:6px; padding:10px; border:1px solid var(--panel-border); background:var(--card-bg); margin-bottom:8px; }
    .cardHead { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
    .badge { font-size:12px; font-weight:700; color:var(--accent); }
    .muted { font-size:10px; color:var(--text-muted); font-family:'Menlo', monospace; }
    .btnRow { display:flex; gap:6px; margin-top:8px; }

    /* Modals & Toast */
    .modal { display:none; position:fixed; inset:0; z-index:100; background: var(--modal-overlay); align-items:center; justify-content:center; backdrop-filter: blur(4px); }
    .modal.open { display:flex; }
    .modalBox { width:380px; max-width:90%; background: #111; border:1px solid var(--panel-border); border-radius:12px; padding:20px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); color:var(--text); }
    .projList { list-style:none; padding:0; margin:10px 0; max-height:300px; overflow-y:auto; border:1px solid var(--panel-border); border-radius:6px; }
    .projItem { padding:8px 10px; border-bottom:1px solid var(--panel-border); display:flex; justify-content:space-between; cursor:pointer; font-size:12px; }
    .projItem:hover { background:var(--btn-hover); }
    
    #toast { position:fixed; left:50%; bottom:30px; transform:translateX(-50%) translateY(20px); padding:8px 16px; border-radius:20px; font-size:12px; background: #111; border:1px solid #333; opacity:0; transition: 0.3s; pointer-events:none; z-index:200; }
    #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>

  <canvas id="gl"></canvas>

  <div id="panel">
    <div id="topBar">
      <div style="display:flex; flex-direction:column; width:100%">
        <span style="font-size:10px; font-weight:700; color:var(--text-muted);">PROYECTO</span>
        <div style="display:flex; align-items:center; gap:8px;">
           <span id="projName">Cargando...</span>
           <button class="iconBtn" id="btnProjects" title="Proyectos"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button>
           <button class="iconBtn" id="btnSave" title="Guardar"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></button>
           <button class="iconBtn" id="btnExport" title="Exportar JSON"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-size:10px; color:var(--text-muted); font-weight:800; margin-bottom:8px;">ESTRUCTURAS</div>
      <div class="row" style="margin:0;">
        <select id="roomSel" style="font-weight:600;"></select>
      </div>
      <div class="btnRow">
        <button class="action" id="btnAddRoom">+ Nueva</button>
        <button class="action" id="btnCloneRoom">Clonar</button>
        <button class="action danger" id="btnDelRoom">Borrar</button>
      </div>
      
      <div class="hr"></div>

      <div class="row"><label>Posición X</label><input id="roomPosX" type="range" min="-50" max="50" step="0.5"><input id="roomPosXNum" type="number" step="0.01" inputmode="decimal"></div>
      <div class="row"><label>Posición Z</label><input id="roomPosZ" type="range" min="-50" max="50" step="0.5"><input id="roomPosZNum" type="number" step="0.01" inputmode="decimal"></div>
      
      <div class="row">
         <label>Dimensión</label>
         <span id="roomDimsInline" style="font-family:monospace; margin-right:auto;">12x10x30</span>
         <button class="action" id="btnEditRoomDims" style="flex:0 0 auto; padding:4px 8px;">Editar</button>
      </div>
      
      <div class="row"><label>Material</label>
        <select id="roomWallType">
          <option value="plaster">Revoque Fino</option>
          <option value="brick">Ladrillo Visto</option>
          <option value="concrete">Hormigón</option>
          <option value="paint">Pintura Satinada</option>
        </select>
      </div>
      
      <div class="row">
        <label>Techo</label>
        <label style="display:flex; align-items:center; gap:6px; font-size:11px; cursor:pointer;">
          <input type="checkbox" id="chkRoof"> Cerrado
        </label>
      </div>
    </div>

    <div class="card">
      <div style="font-size:10px; color:var(--text-muted); font-weight:800; margin-bottom:8px;">ENTORNO & RENDER</div>
      <div class="row">
        <label>Hora (Sol)</label>
        <input id="timeSlider" type="range" min="0" max="24" step="0.1" value="12" />
        <span id="timeDisplay" style="font-family:monospace; font-size:11px; width:35px; text-align:right;">12:00</span>
      </div>
      <div class="row"><label>Exposición</label><input id="exp" type="range" min="0.1" max="4.0" step="0.05" value="1.0"/></div>
      <div class="row"><label>Ambiente</label><input id="amb" type="range" min="0" max="2.0" step="0.05" value="0.2"/></div>
      <div class="row">
        <label>Efectos</label>
        <label style="display:flex; align-items:center; gap:6px; font-size:11px; cursor:pointer;">
          <input type="checkbox" id="chkBloom" checked> Bloom (Brillo)
        </label>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label>Luz Activa</label>
      <select id="sel"></select>
    </div>
    <div class="btnRow">
      <button class="action primary" id="add">+ Luz</button>
      <button class="action" id="clone">Clonar</button>
      <button class="action danger" id="del">Eliminar</button>
    </div>
    
    <div class="card" id="editCard" style="margin-top:10px;">
      <div class="cardHead">
        <div><div class="badge" id="name">Reflector</div><div class="tiny muted" id="posRead">x=0 y=0 z=0</div></div>
        <div class="badge" id="watRead" style="font-weight:400">0 W</div>
      </div>
      <div class="row"><label>Tipo</label>
        <select id="lType">
          <option value="0">LED (Bulbo)</option>
          <option value="1">Reflector (Spot)</option>
          <option value="2">Farola (Poste)</option>
        </select>
      </div>
      <div class="row"><label>Color</label><input id="clr" type="color" value="#ffffff"/></div>
      <div class="row"><label>Potencia</label><input id="wat" type="range" min="1" max="100" step="1"/><input id="watNum" type="number" min="1" max="100" step="1"/>
</div>
      <div class="row"><label>Altura (Y)</label><input id="y" type="range" min="0.1" max="20" step="0.1"/><input id="yNum" type="number" step="0.01" inputmode="decimal"/></div>
      <div class="row"><label>Pos X</label><input id="x" type="range" min="-50" max="50" step="0.1"/><input id="xNum" type="number" step="0.01" inputmode="decimal"/></div>
      <div class="row"><label>Pos Z</label><input id="z" type="range" min="-50" max="50" step="0.1"/><input id="zNum" type="number" step="0.01" inputmode="decimal"/></div>
      <div class="row"><label>Ángulo</label><input id="angle" type="range" min="10" max="120" step="1"/><input id="angleNum" type="number"/></div>
      <div class="row"><label>Alcance</label><input id="dist" type="range" min="1" max="150" step="1"/><input id="distNum" type="number"/></div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label>Control</label>
      <label style="display:flex; align-items:center; gap:6px; font-size:11px; cursor:pointer; color: var(--accent);">
        <input type="checkbox" id="chkWalk"> <b>1ª Persona (WASD)</b>
      </label>
    </div>
    <div class="btnRow"><button class="action" id="resetCam">Reset Cámara</button></div>
    <div class="muted" style="margin-top:12px; text-align: right;">Luces: <b id="cntL">0</b>/32</div>
  </div>

  <div id="modalProjects" class="modal">
    <div class="modalBox">
      <div class="cardHead"><h3>Mis Proyectos</h3><span class="modalClose" data-close="modalProjects">&times;</span></div>
      <button class="action primary" id="btnNewProj" style="width:100%; margin-bottom:10px;">+ Nuevo Proyecto</button>
      <ul id="projList" class="projList"></ul>
      <div class="row"><input type="text" id="renameInput" placeholder="Renombrar..." /><button class="action" id="btnRenameAction">OK</button></div>
    </div>
  </div>

  <div id="modalRoom" class="modal">
    <div class="modalBox">
      <div class="cardHead"><h3>Dimensiones</h3><span class="modalClose" data-close="modalRoom">&times;</span></div>
      <div class="row"><label>Ancho (X)</label><input id="roomW" type="number" step="0.1" min="1"></div>
      <div class="row"><label>Alto (Y)</label><input id="roomH" type="number" step="0.1" min="1"></div>
      <div class="row"><label>Largo (Z)</label><input id="roomL" type="number" step="0.1" min="1"></div>
      <div class="btnRow" style="margin-top:20px">
        <button class="action" data-close="modalRoom">Cancelar</button>
        <button class="action primary" id="btnApplyRoom">Aplicar</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>
  
  <script type="module">
    import * as THREE from 'three';
    import { Sky } from 'three/addons/objects/Sky.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

    const uid = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    const toast = (m) => {
        const t = document.getElementById('toast');
        if(t) { t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    };
    const formatTime = (t) => {
        const h = Math.floor(t); const m = Math.floor((t - h) * 60);
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    };

    // --- TEXTURE GEN ---
    const TextureGen = {
        cache: {},
        get(type, width, height) {
            const key = `${type}_${Math.round(width)}x${Math.round(height)}`;
            if(this.cache[key]) return this.cache[key];
            
            const s = 512;
            const cvs = document.createElement('canvas'); cvs.width = s; cvs.height = s;
            const ctx = cvs.getContext('2d');

            ctx.fillStyle = '#888'; ctx.fillRect(0,0,s,s);
            if(type === 'brick') {
                ctx.fillStyle = '#8a5a44'; ctx.fillRect(0,0,s,s);
                ctx.fillStyle = '#6d4c41';
                for(let y=0; y<s; y+=64) {
                    let off = (y/64)%2===0?0:64;
                    for(let x=-64; x<s; x+=128) ctx.fillRect(x+off, y, 120, 56);
                }
            } else if (type === 'concrete') {
                ctx.fillStyle = '#999'; ctx.fillRect(0,0,s,s);
                for(let i=0; i<5000; i++) {
                   ctx.fillStyle = Math.random()>0.5 ? '#aaa' : '#888';
                   ctx.fillRect(Math.random()*s, Math.random()*s, 2, 2);
                }
            } else if (type === 'paint') {
                ctx.fillStyle = '#eeeeee'; ctx.fillRect(0,0,s,s); 
            }
            
            const id = ctx.getImageData(0,0,s,s);
            for(let i=0; i<id.data.length; i+=4) {
                const n = (Math.random()-0.5)*10;
                id.data[i]+=n; id.data[i+1]+=n; id.data[i+2]+=n;
            }
            ctx.putImageData(id,0,0);

            const tex = new THREE.CanvasTexture(cvs);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(Math.max(1, width/3), Math.max(1, height/3));
            tex.anisotropy = 4;
            tex.colorSpace = THREE.SRGBColorSpace;
            
            this.cache[key] = tex;
            return tex;
        }
    };

    // --- STATE ---
    const STATE = {
        key: 'sim3d_pro_v6_2',
        current: null, projects: {}, activeRoomIndex: 0,
        template: () => ({
            id: uid(), name: "Nuevo Proyecto", updated: Date.now(),
            rooms: [{ id: uid(), name: "Estructura 1", w:12, h:8, l:20, x:0, z:0, roof:true, wallType:'plaster' }],
            env: { time: 14.0, exp: 1.0, amb: 0.2, bloom: true },
            camera: { pos: [0, 5, 30], yaw: 0, pitch: -0.1 },
            lights: []
        }),
        init() {
            try {
                const raw = localStorage.getItem(this.key);
                if(raw) {
                    const data = JSON.parse(raw);
                    this.projects = data.projects || {};
                    if(data.activeId && this.projects[data.activeId]) this.current = this.projects[data.activeId];
                }
            } catch(e) { console.error(e); }
            if(!this.current) this.create();
        },
        create() { const p = this.template(); this.projects[p.id] = p; this.load(p.id); },
        load(id) {
            if(!this.projects[id]) return;
            this.current = JSON.parse(JSON.stringify(this.projects[id]));
            this.activeRoomIndex = 0;
            this.save();
            if(APP.gl.scene) {
                APP.gl.loadScene(this.current);
                APP.ui.syncAll();
            }
        },
        save() {
            if(!this.current) return;
            this.current.updated = Date.now();
            this.projects[this.current.id] = this.current;
            localStorage.setItem(this.key, JSON.stringify({ activeId: this.current.id, projects: this.projects }));
        },
        addRoom() { 
            this.current.rooms.push({ id:uid(), name:`Estructura ${this.current.rooms.length+1}`, w:10, h:8, l:10, x:10, z:0, roof:true, wallType:'plaster' });
            this.activeRoomIndex = this.current.rooms.length-1;
            this.save(); APP.gl.buildRooms(); APP.ui.syncRoomUI();
        },
        deleteProj(id) {
            if(Object.keys(this.projects).length <= 1) return toast("Mínimo 1 proyecto");
            delete this.projects[id];
            if(this.current.id === id) this.load(Object.keys(this.projects)[0]);
            else this.save();
            APP.ui.renderProjectList();
        },
        rename(name) {
            if(this.current) { this.current.name = name; this.save(); APP.ui.syncAll(); }
        }
    };

    // --- ENGINE ---
    const APP = {
        gl: {
            scene: null, camera: null, renderer: null, composer: null,
            meshes: { rooms: [], lights: [] },
            raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
            keys: {},
            camData: { yaw: 0, pitch: 0 },
            walk: false, velY: 0,
            dragging: false, // For Editor Mode
            
            init() {
                const cvs = document.getElementById('gl');
                this.renderer = new THREE.WebGLRenderer({ canvas:cvs, antialias:false, powerPreference:'high-performance' });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
                this.camera.rotation.order = 'YXZ';

                this.sky = new Sky();
                this.sky.scale.setScalar(450000);
                this.scene.add(this.sky);
                
                this.sunLight = new THREE.DirectionalLight(0xffffff, 3);
                this.sunLight.castShadow = true;
                this.sunLight.shadow.mapSize.width = 2048;
                this.sunLight.shadow.mapSize.height = 2048;
                this.sunLight.shadow.bias = -0.0001;
                this.scene.add(this.sunLight);
                
                this.ambient = new THREE.AmbientLight(0xffffff, 0.2);
                this.scene.add(this.ambient);

                const ground = new THREE.Mesh(new THREE.PlaneGeometry(500,500), new THREE.MeshStandardMaterial({ color:0x111111, roughness:0.8 }));
                ground.rotation.x = -Math.PI/2;
                ground.position.y = -0.05;
                ground.receiveShadow = true;
                this.scene.add(ground);
                
                this.grid = new THREE.GridHelper(200, 200, 0x444444, 0x111111);
                this.scene.add(this.grid);

                this.composer = new EffectComposer(this.renderer);
                this.composer.addPass(new RenderPass(this.scene, this.camera));
                this.bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                this.bloomPass.threshold = 0.9; this.bloomPass.strength = 0.5; this.bloomPass.radius = 0.5;
                this.composer.addPass(this.bloomPass);
                this.composer.addPass(new OutputPass());

                // Events
                window.addEventListener('resize', () => this.resize());
                window.addEventListener('keydown', e => this.keys[e.code] = true);
                window.addEventListener('keyup', e => this.keys[e.code] = false);
                
                cvs.addEventListener('mousedown', e => {
                    if(this.walk) {
                        if(!e.shiftKey) cvs.requestPointerLock();
                    } else {
                        // Editor Mode: Right click drag
                        if(e.button === 2) { this.dragging = true; e.preventDefault(); }
                    }
                    if(e.button === 0 && e.shiftKey) this.doRaycast(e.clientX, e.clientY);
                });
                
                window.addEventListener('mouseup', () => this.dragging = false);
                window.addEventListener('contextmenu', e => e.preventDefault()); // Block context menu on canvas

                document.addEventListener('mousemove', e => {
                    // Yaw/Pitch rotation
                    if((this.walk && document.pointerLockElement === cvs) || (!this.walk && this.dragging)) {
                        const sens = this.walk ? 0.002 : 0.004;
                        this.camData.yaw -= e.movementX * sens;
                        this.camData.pitch -= e.movementY * sens;
                        this.camData.pitch = Math.max(-1.5, Math.min(1.5, this.camData.pitch));
                    }
                });

                // Editor Zoom
                cvs.addEventListener('wheel', e => {
                    if(this.walk) return;
                    e.preventDefault();
                    const dir = new THREE.Vector3();
                    this.camera.getWorldDirection(dir);
                    const dist = e.deltaY > 0 ? -2 : 2;
                    this.camera.position.addScaledVector(dir, dist);
                }, { passive: false });

                this.animate();
            },

            resize() {
                const w = window.innerWidth, h = window.innerHeight;
                this.renderer.setSize(w, h);
                this.composer.setSize(w, h);
                this.camera.aspect = w/h;
                this.camera.updateProjectionMatrix();
            },

            loadScene(data) {
                if(data.camera) {
                    this.camera.position.fromArray(data.camera.pos);
                    this.camData.yaw = data.camera.yaw;
                    this.camData.pitch = data.camera.pitch;
                }
                this.updateEnv(data.env);
                this.buildRooms();
                this.buildLights();
            },

            updateEnv(env) {
                const phi = THREE.MathUtils.degToRad(90 - (env.time - 12) * 15);
                const theta = THREE.MathUtils.degToRad(180);
                const sunPos = new THREE.Vector3().setFromSphericalCoords(1, phi, theta);
                this.sky.material.uniforms['sunPosition'].value.copy(sunPos);
                this.sunLight.position.copy(sunPos).multiplyScalar(50);
                
                const isNight = env.time < 6 || env.time > 18;
                this.sunLight.intensity = isNight ? 0 : 2.0;
                this.ambient.intensity = env.amb * (isNight ? 0.2 : 1.0);
                this.renderer.toneMappingExposure = env.exp;
                this.bloomPass.enabled = env.bloom;
            },

            buildRooms() {
                this.meshes.rooms.forEach(m => this.scene.remove(m));
                this.meshes.rooms = [];
                const rooms = STATE.current.rooms;
                
                rooms.forEach(r => {
                    const grp = new THREE.Group();
                    grp.position.set(r.x, 0, r.z);
                    const matWall = new THREE.MeshStandardMaterial({
                        map: TextureGen.get(r.wallType, r.w, r.h), roughness: 0.8, bumpScale: 0.02
                    });
                    const matRoof = new THREE.MeshStandardMaterial({ color:0xffffff, side:THREE.DoubleSide });
                    const T = 0.2; const hw = r.w/2, hh = r.h/2, hl = r.l/2;
                    const mkWall = (w, h, d, x, y, z, rotY) => {
                        const g = new THREE.BoxGeometry(w, h, d);
                        const m = new THREE.Mesh(g, matWall);
                        m.position.set(x, y, z);
                        if(rotY) m.rotation.y = rotY;
                        m.castShadow = true; m.receiveShadow = true;
                        return m;
                    };
                    grp.add(mkWall(r.w, r.h, T, 0, hh, -hl+T/2, 0)); 
                    grp.add(mkWall(r.w, r.h, T, 0, hh, hl-T/2, 0));
                    grp.add(mkWall(r.l-2*T, r.h, T, -hw+T/2, hh, 0, Math.PI/2)); 
                    grp.add(mkWall(r.l-2*T, r.h, T, hw-T/2, hh, 0, Math.PI/2)); 
                    if(r.roof) {
                        const roof = new THREE.Mesh(new THREE.PlaneGeometry(r.w, r.l), matRoof);
                        roof.rotation.x = Math.PI/2; roof.position.y = r.h;
                        roof.castShadow = true; roof.receiveShadow = true; grp.add(roof);
                    }
                    this.scene.add(grp); this.meshes.rooms.push(grp);
                });
            },

            buildLights() {
                this.meshes.lights.forEach(l => { 
                    this.scene.remove(l.mesh); this.scene.remove(l.light); if(l.target) this.scene.remove(l.target); 
                });
                this.meshes.lights = [];
                STATE.current.lights.forEach((d, i) => {
                    let l;
const col = new THREE.Color(d.color);

// ✅ clamp por compatibilidad con proyectos viejos que tengan watts > 100
const watts = Math.max(1, Math.min(100, Number(d.watts) || 1));
d.watts = watts;

// ✅ curva no-lineal: suave al principio, muy agresiva cerca de 100 ("encandila")
const w = watts / 100;                 // 0..1
const intensity = 80 + 4200 * (w ** 2.6);  // ajusta el "golpe" final

                    if(d.type === 0 || d.type === 2) { 
                        l = new THREE.PointLight(col, intensity, d.dist); l.decay = 2;
                    } else { 
                        l = new THREE.SpotLight(col, intensity, d.dist, THREE.MathUtils.degToRad(d.angle/2), 0.3, 2);
                        l.target.position.set(d.x, 0, d.z); this.scene.add(l.target);
                    }
                    l.position.set(d.x, d.y, d.z); l.castShadow = true; l.shadow.bias = -0.0001; l.shadow.mapSize.set(1024,1024);
                    const geo = d.type===0 ? new THREE.SphereGeometry(0.2) : new THREE.CylinderGeometry(0.1, 0.2, 0.4);
                    if(d.type !== 0) geo.rotateX(-Math.PI/2);
                    const mat = new THREE.MeshBasicMaterial({ color: col });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.copy(l.position);
                    if(d.type === 1) mesh.lookAt(d.x, 0, d.z);
                    this.scene.add(l); this.scene.add(mesh);
                    this.meshes.lights.push({ light:l, mesh:mesh, target:l.target, data:d });
                });
                this.updateSelectionVisuals();
            },

            doRaycast(mx, my) {
                this.mouse.x = (mx / window.innerWidth) * 2 - 1;
                this.mouse.y = -(my / window.innerHeight) * 2 + 1;
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const hits = this.raycaster.intersectObjects(this.meshes.lights.map(x=>x.mesh));
                if(hits.length > 0) {
                    const found = this.meshes.lights.find(x => x.mesh === hits[0].object);
                    APP.ui.selectLight(this.meshes.lights.indexOf(found));
                }
            },

            updateSelectionVisuals() {
                this.meshes.lights.forEach((x, i) => {
                    const sel = (i === APP.ui.selectedIdx);
                    x.mesh.scale.setScalar(sel ? 1.5 : 1.0);
                    const col = new THREE.Color(x.data.color);
                    x.mesh.material.color.setHex(sel ? 0xffff00 : col.getHex());
                });
            },

            animate() {
                requestAnimationFrame(() => this.animate());
                
                const cam = this.camera;
                cam.rotation.y = this.camData.yaw;
                cam.rotation.x = this.camData.pitch;

                // Move logic (Works for both modes now)
                const speed = 0.15;
                const dir = new THREE.Vector3();
                const right = new THREE.Vector3();
                cam.getWorldDirection(dir); dir.y = 0; dir.normalize();
                right.crossVectors(dir, new THREE.Vector3(0,1,0)).normalize();

                if(this.keys['KeyW']) cam.position.addScaledVector(dir, speed);
                if(this.keys['KeyS']) cam.position.addScaledVector(dir, -speed);
                if(this.keys['KeyD']) cam.position.addScaledVector(right, speed);
                if(this.keys['KeyA']) cam.position.addScaledVector(right, -speed);
                // Vertical (Q/E or Space/Shift)
                if(this.keys['KeyE']) cam.position.y += speed;
                if(this.keys['KeyQ']) cam.position.y -= speed;

                if(this.walk) {
                   // Gravity Logic for Walk Mode
                   const floorY = 1.7;
                   if(this.keys['Space'] && cam.position.y <= floorY+0.1) this.velY = 0.2;
                   this.velY -= 0.01;
                   cam.position.y += this.velY;
                   if(cam.position.y < floorY) { cam.position.y = floorY; this.velY = 0; }
                } 
                
                if(STATE.current && STATE.current.camera) {
                    STATE.current.camera.pos = cam.position.toArray();
                    STATE.current.camera.yaw = this.camData.yaw;
                    STATE.current.camera.pitch = this.camData.pitch;
                }

                this.composer.render();
            }
        },

        ui: {
            el: {}, ready: false, selectedIdx: -1,
            // --- FIX: refrescar selector de luces y clamp de índice ---
clampSelectedLight() {
  const n = STATE.current.lights.length;
  if (n <= 0) { this.selectedIdx = -1; return; }
  if (this.selectedIdx < 0) this.selectedIdx = 0;
  if (this.selectedIdx >= n) this.selectedIdx = n - 1;
},

refreshLightSelect(keepIdx = true) {
  const sel = document.getElementById('sel');
  if (!sel) return;

  const prev = keepIdx ? this.selectedIdx : -1;

  sel.innerHTML = '';
  STATE.current.lights.forEach((l, i) => {
    const o = document.createElement('option');
    o.value = String(i);
    o.text = l.name || `Luz ${i + 1}`;
    sel.appendChild(o);
  });

  // Clamp y aplicar selección
  this.selectedIdx = prev;
  this.clampSelectedLight();

  if (this.selectedIdx >= 0) sel.value = String(this.selectedIdx);
  else sel.value = '';
},

            init() {
                const $ = (id) => document.getElementById(id);
                const bind = (id, evt, cb) => { const el=$(id); if(el) el.addEventListener(evt, cb); };
                
                bind('roomSel', 'change', e => { STATE.activeRoomIndex = parseInt(e.target.value); this.syncRoomUI(); });
                bind('btnAddRoom', 'click', () => STATE.addRoom());
                bind('btnCloneRoom', 'click', () => {
  const r = STATE.current.rooms[STATE.activeRoomIndex];
  if(!r) return;

  const copy = {
    ...r,
    id: uid(),
    name: (r.name || 'Estructura') + ' (C)',
    x: (parseFloat(r.x) || 0) + 2,
    z: (parseFloat(r.z) || 0) + 2
  };

  STATE.current.rooms.push(copy);
  STATE.activeRoomIndex = STATE.current.rooms.length - 1;

  STATE.save();
  APP.gl.buildRooms();
  APP.ui.syncRoomUI();
  toast("Estructura clonada");
});

                bind('btnDelRoom', 'click', () => { STATE.current.rooms.splice(STATE.activeRoomIndex,1); STATE.activeRoomIndex=0; STATE.save(); APP.gl.buildRooms(); this.syncRoomUI(); });
                bind('chkRoof', 'change', e => { STATE.current.rooms[STATE.activeRoomIndex].roof = e.target.checked; STATE.save(); APP.gl.buildRooms(); });
                bind('roomWallType', 'change', e => { STATE.current.rooms[STATE.activeRoomIndex].wallType = e.target.value; STATE.save(); APP.gl.buildRooms(); });
                
                bind('btnEditRoomDims', 'click', () => {
                    const r = STATE.current.rooms[STATE.activeRoomIndex];
                    $('roomW').value=r.w; $('roomH').value=r.h; $('roomL').value=r.l;
                    $('modalRoom').classList.add('open');
                });
                bind('btnApplyRoom', 'click', () => {
                    const r = STATE.current.rooms[STATE.activeRoomIndex];
                    r.w = parseFloat($('roomW').value); r.h = parseFloat($('roomH').value); r.l = parseFloat($('roomL').value);
                    STATE.save(); APP.gl.buildRooms(); this.syncRoomUI();
                    document.querySelectorAll('.modal').forEach(m=>m.classList.remove('open'));
                });

                const updPos = (isNum) => {
                    const r = STATE.current.rooms[STATE.activeRoomIndex];
                    const xVal = parseFloat($(isNum ? 'roomPosXNum' : 'roomPosX').value);
                    const zVal = parseFloat($(isNum ? 'roomPosZNum' : 'roomPosZ').value);
                    r.x = xVal; r.z = zVal;
                    $('roomPosX').value = r.x; $('roomPosXNum').value = r.x;
                    $('roomPosZ').value = r.z; $('roomPosZNum').value = r.z;
                    STATE.save(); APP.gl.buildRooms();
                };
                bind('roomPosX', 'input', () => updPos(false)); bind('roomPosXNum', 'input', () => updPos(true));
                bind('roomPosZ', 'input', () => updPos(false)); bind('roomPosZNum', 'input', () => updPos(true));

const updEnv = () => {
  const env = STATE.current.env;
  env.time = parseFloat($('timeSlider').value);
  env.exp = parseFloat($('exp').value);
  env.amb = parseFloat($('amb').value);
  env.bloom = $('chkBloom').checked;

  $('timeDisplay').innerText = formatTime(env.time);
  APP.gl.updateEnv(env);

  STATE.save(); // ✅ persistir entorno
};

                bind('timeSlider', 'input', updEnv);
                bind('exp', 'input', updEnv); bind('amb', 'input', updEnv);
                bind('chkBloom', 'change', updEnv);

                bind('sel', 'change', e => this.selectLight(parseInt(e.target.value)));
bind('add', 'click', () => {
  STATE.current.lights.push({
    name: `Luz ${STATE.current.lights.length + 1}`,
    type: 1,
    color: '#ffffff',
    watts: 30,
    x: 0, y: 5, z: 0,
    angle: 60,
    dist: 50
  });

  STATE.save();
  APP.gl.buildLights();

  // ✅ FIX: reconstruir el select y seleccionar la nueva
  this.selectedIdx = STATE.current.lights.length - 1;
  this.refreshLightSelect(true);
  this.selectLight(this.selectedIdx);
});

bind('del', 'click', () => {
  if (this.selectedIdx < 0) return;

  STATE.current.lights.splice(this.selectedIdx, 1);

  // ✅ FIX: clamp correcto post-borrado
  if (STATE.current.lights.length === 0) this.selectedIdx = -1;
  else this.selectedIdx = Math.min(this.selectedIdx, STATE.current.lights.length - 1);

  STATE.save();
  APP.gl.buildLights();

  // ✅ FIX: reconstruir el select + re-seleccionar
  this.refreshLightSelect(true);
  this.selectLight(this.selectedIdx);
  document.getElementById('cntL').innerText = STATE.current.lights.length;
});

bind('clone', 'click', () => {
  if (this.selectedIdx < 0) return;

  const src = STATE.current.lights[this.selectedIdx];

  STATE.current.lights.push({
    ...src,
    name: (src.name || 'Luz') + ' (C)',
    x: (parseFloat(src.x) || 0) + 1,
    z: (parseFloat(src.z) || 0) + 1
  });

  STATE.save();
  APP.gl.buildLights();

  // ✅ FIX: reconstruir el select y seleccionar clonada
  this.selectedIdx = STATE.current.lights.length - 1;
  this.refreshLightSelect(true);
  this.selectLight(this.selectedIdx);
});


const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
const toNum = (x, fallback=0) => (Number.isFinite(parseFloat(x)) ? parseFloat(x) : fallback);

const updLight = (k, v) => {
  if (this.selectedIdx < 0) return;

  // Normalizar numérico
  let val = v;

  if (k === 'watts') {
    val = clamp(Math.round(toNum(v, 1)), 1, 100); // ✅ nunca >100
    // Mantener inputs sincronizados
    const r = document.getElementById('wat');
    const n = document.getElementById('watNum');
    if (r) r.value = String(val);
    if (n) n.value = String(val);
  } else if (typeof v === 'number' || (typeof v === 'string' && v.trim() !== '')) {
    val = toNum(v, v);
  }

  STATE.current.lights[this.selectedIdx][k] = val;

  STATE.save();         // persistir
  APP.gl.buildLights(); // re-render
};


                ['wat','x','y','z','angle','dist'].forEach(k => {
                    const key = k==='wat'?'watts':k;
                    bind(k, 'input', e => { const v = parseFloat(e.target.value); $(k+'Num').value = v; updLight(key, v); });
                    bind(k+'Num', 'input', e => { const v = parseFloat(e.target.value); $(k).value = v; updLight(key, v); });
                });
                bind('clr', 'input', e => updLight('color', e.target.value));
                bind('lType', 'change', e => { updLight('type', parseInt(e.target.value)); });

                bind('chkWalk', 'change', e => { 
                    APP.gl.walk = e.target.checked; 
                    if(!APP.gl.walk && document.pointerLockElement) document.exitPointerLock();
                });
                bind('resetCam', 'click', () => { APP.gl.camera.position.set(0,5,30); APP.gl.camData={yaw:0,pitch:0}; });
                
                bind('btnProjects', 'click', () => { this.renderProjectList(); $('modalProjects').classList.add('open'); });
                bind('btnNewProj', 'click', () => STATE.create());
                bind('btnRenameAction', 'click', () => STATE.rename($('renameInput').value));
                bind('btnExport', 'click', () => {
                    const blob = new Blob([JSON.stringify(STATE.current)], {type:'application/json'});
                    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='proyecto.json'; a.click();
                });
                bind('btnSave', 'click', () => { 
  STATE.save(); 
  toast("Guardado"); 
});

                document.querySelectorAll('.modalClose').forEach(b => b.onclick = () => document.querySelectorAll('.modal').forEach(m=>m.classList.remove('open')));

                this.ready = true;
            },

            syncAll() {
                if(!this.ready) return;
                // Force Update Header
                const nEl = document.getElementById('projName'); if(nEl) nEl.textContent = STATE.current.name;
                const iEl = document.getElementById('renameInput'); if(iEl) iEl.value = STATE.current.name;
                
                this.syncRoomUI();
                const env = STATE.current.env;
                document.getElementById('timeSlider').value = env.time;
                document.getElementById('exp').value = env.exp;
                document.getElementById('amb').value = env.amb;
                document.getElementById('chkBloom').checked = env.bloom;
                
                this.refreshLightSelect(true);
this.selectLight(this.selectedIdx);

                document.getElementById('cntL').innerText = STATE.current.lights.length;
            },

            syncRoomUI() {
                const r = STATE.current.rooms[STATE.activeRoomIndex];
                if(!r) return;
                const sel = document.getElementById('roomSel');
                sel.innerHTML = '';
                STATE.current.rooms.forEach((rm, i) => {
                    const o = document.createElement('option'); o.value = i; o.text = rm.name;
                    sel.appendChild(o);
                });
                sel.value = STATE.activeRoomIndex;
                document.getElementById('roomPosX').value = r.x; document.getElementById('roomPosXNum').value = r.x;
                document.getElementById('roomPosZ').value = r.z; document.getElementById('roomPosZNum').value = r.z;
                document.getElementById('roomDimsInline').innerText = `${r.w}x${r.h}x${r.l}`;
                document.getElementById('chkRoof').checked = r.roof;
                document.getElementById('roomWallType').value = r.wallType || 'plaster';
            },

            selectLight(idx) {
                this.selectedIdx = idx;
                const sel = document.getElementById('sel'); if(sel) sel.value = idx;
                const card = document.getElementById('editCard');
                if(idx < 0) {
                    if(card) { card.style.opacity = 0.5; card.style.pointerEvents = 'none'; }
                    return;
                }
                if(card) { card.style.opacity = 1; card.style.pointerEvents = 'auto'; }
                const l = STATE.current.lights[idx];
                
                const set = (id, v) => { 
                    const el = document.getElementById(id); if(!el) return;
                    if(el.tagName === 'INPUT' || el.tagName === 'SELECT') el.value = v;
                    else el.textContent = v;
                };
                
                set('name', l.name); set('wat', l.watts); set('watNum', l.watts);
                set('x', l.x); set('xNum', l.x); set('y', l.y); set('yNum', l.y); set('z', l.z); set('zNum', l.z);
                set('clr', l.color); set('lType', l.type); 
                set('angle', l.angle); set('angleNum', l.angle); set('dist', l.dist); set('distNum', l.dist);
                
                const wr = document.getElementById('watRead'); if(wr) wr.textContent = l.watts + ' W';
                APP.gl.updateSelectionVisuals();
            },

            renderProjectList() {
                const ul = document.getElementById('projList');
                ul.innerHTML = '';
                Object.values(STATE.projects).forEach(p => {
                    const li = document.createElement('li'); li.className = 'projItem';
                    li.innerHTML = `<span>${p.name}</span> <button class="iconBtn" data-del="${p.id}">&times;</button>`;
                    li.onclick = (e) => { 
                        if(e.target.tagName === 'BUTTON') {
  if(confirm("¿Eliminar proyecto?")) STATE.deleteProj(p.id);
}

                        else STATE.load(p.id); 
                    };
                    ul.appendChild(li);
                });
            }
        }
    };

    window.onload = () => {
        STATE.init();
        APP.gl.init();
        APP.ui.init();
        if(STATE.current) {
            APP.gl.loadScene(STATE.current);
            APP.ui.syncAll();
        }
    };
  </script>
</body>
</html>
